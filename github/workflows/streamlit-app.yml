name: Deploy Streamlit App to Snowflake

on:
  push:
    branches:
      - main

env:
  PYTHON_VERSION: '3.11'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Snowflake CLI
        run: |
          python -m pip install --upgrade pip
          pip install snowflake-cli

      - name: Create Snowflake CLI config
        env:
          SNOWFLAKE_ACCOUNT: ${{ secrets.SNOWCLI_ACCOUNT }}
          SNOWFLAKE_USER: ${{ secrets.SNOWCLI_USER }}
          SNOWFLAKE_PASSWORD: ${{ secrets.SNOWCLI_PW }}
          SNOWFLAKE_ROLE: ${{ secrets.SNOWCLI_ROLE }}
          SNOWFLAKE_DATABASE: ${{ secrets.SNOWCLI_DATABASE }}
          SNOWFLAKE_WAREHOUSE: ${{ secrets.SNOWCLI_WAREHOUSE }}
        run: |
          mkdir -p ~/.snowflake
          cat << EOF > ~/.snowflake/config.toml
          [connections.default]
          account = "$SNOWFLAKE_ACCOUNT"
          user = "$SNOWFLAKE_USER"
          password = "$SNOWFLAKE_PASSWORD"
          EOF
          chmod 0600 ~/.snowflake/config.toml

      - name: Deploy Streamlit app to Snowflake
        run: snow streamlit deploy --replace --database PROSPECT_FINDER_APP --schema PUBLIC
